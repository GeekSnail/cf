# This is a basic workflow to help you get started with Actions

name: IP Workflow

# Controls when the workflow will run
on:
  schedule:
    - cron: "25 8 * * *"
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
  #  branches: [ "main" ]
  #pull_request:
  #  branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  CF_KV_API: https://api.cloudflare.com/client/v4/accounts/${{secrets.CF_ACCOUNT_ID}}/storage/kv/namespaces/${{secrets.CF_NAMESPACE_ID}}/values
  PROXYS: proxys
  PROXYS_BAK: proxys_bak
  PROXYS_UPDATED: proxys_updated

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
      # Runs a single command using the runners shell
      #- name: Run a one-line script
      #  run: echo Hello, world!

      # Runs a set of commands using the runners shell
      #- name: Run a multi-line script
      #  run: |
      #    echo Add other actions to build,
      #    echo test, and deploy your project.
      - name: test data
        run: |
          cat > valid_ips.txt <<EOF
          47.245.114.163
          8.219.103.65
          8.219.110.248
          8.219.111.147
          8.219.111.175
          8.219.122.55
          8.219.124.227
          8.219.126.240
          8.219.142.191
          8.219.161.129
          8.219.170.232
          8.219.174.142
          8.219.193.202
          8.219.198.139
          8.219.199.220
          8.219.201.245
          8.219.235.164
          8.219.237.250
          8.219.240.160
          8.219.4.122
          8.219.42.72
          8.219.5.10
          8.219.50.180
          8.219.51.211
          8.219.67.133
          8.219.84.214
          8.219.98.13
          8.222.187.4
          8.222.208.38
          8.222.214.231
          EOF
          wc -l valid_ips.txt
  
      - name: Backup original data, append into valid_ips.txt
        run: |
          ret=`curl -H "Authorization:Bearer ${{secrets.CF_API_TOKEN}}" "$CF_KV_API/$PROXYS"`
          if [[ "$orig_data" == *error* ]]; then
            echo $ret
          else
            #curl -X PUT -H "Authorization:Bearer ${{secrets.CF_API_TOKEN}}" -d "$ret" "$CF_KV_API/$PROXYS_BAK"
            echo "$ret" |tr -d '["]'|sed -r 's/,| /\n/g' >> valid_ips.txt
            cat valid_ips.txt | sort | uniq > tmp.txt
            mv tmp.txt valid_ips.txt
            wc -l valid_ips.txt
          fi

      - name: SSL/TLS Handshake Test
        run: |          
          touch valid_ips_with_ssl.txt
          while IFS= read -r ip || [ $ip ]; do
            retry=false
            while true; do
              ret=`echo|openssl s_client -connect $ip:443 --noservername -brief 2>&1|tr -s '\n\r' ' '`
              case "$ret" in
                *410*|*write:errno=*)  
                  echo $ret ; 
                  $retry || (retry=true && echo "retry $ip" && continue) 
                  ;; # 410: alert handshake failure
                *Verification:\ OK*) echo "$ip" >> valid_ips_with_ssl.txt ;;
                *458*)               echo "$ip" >> valid_ips_with_ssl.txt ;; # unrecognized name                
                *connect\ error*)    echo connect error ;;
                #*verify\ error*)    echo error ;; # self signed certificate, expired
                *)                   echo "$ip $ret" ;;
              esac
              break;
            done
          done < valid_ips.txt
          wc -l valid_ips_with_ssl.txt

      - name: Upload IPs file
        uses: actions/upload-artifact@v4
        with:
          name: cf-proxys
          path: valid_ips_with_ssl.txt
          
      - name: Update valid IPs to server
        run: |
          if [ -s valid_ips_with_ssl.txt ]; then
            data=`echo $(cat valid_ips_with_ssl.txt)`
            curl -X PUT -H "Authorization:Bearer ${{secrets.CF_API_TOKEN}}" \
              -d "$data" "$CF_KV_API/$PROXYS"
            curl -X PUT -H "Authorization:Bearer ${{secrets.CF_API_TOKEN}}" \
              -d "`date +%s%3N`" "$CF_KV_API/$PROXYS_UPDATED"
          fi
